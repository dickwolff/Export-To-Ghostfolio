<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Export to Ghostfolio | All files</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body class="files-page">
    <div class="container">
        <div class="header">
            <h1>Export to Ghostfolio</h1>
        </div>

        <div class="main-content">
            <div class="upload-section" style="height: 100%;">
                <div style="margin-bottom: 1.5rem;">
                    <a href="/" class="view-all-link">‚Üê Back</a>
                </div>

                <h2 class="section-title">All Output Files</h2>

                <div class="files-grid" id="filesGrid">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÅ</div>
                        <p>Loading files...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Load all output files
        async function loadAllFiles() {
            try {
                const response = await fetch("/api/output-files?limit=-1");
                const files = await response.json();

                renderFiles(files);
            } catch (error) {
                console.error("Failed to load files:", error);
                document.getElementById("filesGrid").innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ùå</div>
                        <p>Failed to load files: ${error.message}</p>
                    </div>
                `;
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return "0 B";
            const k = 1024;
            const sizes = ["B", "KB", "MB", "GB"];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + " " + sizes[i];
        }

        function escapeHtml(text) {
            const div = document.createElement("div");
            div.textContent = text;
            return div.innerHTML;
        }

        function renderFiles(files) {
            const filesGrid = document.getElementById("filesGrid");

            if (files.length === 0) {
                filesGrid.innerHTML = `
                    <div class="empty-state">
                        <p class="no-files-message">No files generated yet..</p>
                    </div>
                `;
                return;
            }

            filesGrid.innerHTML = files.map(file => `
                <div class="file-item-detailed">
                    <div class="file-info-detailed">
                        <div class="file-name">${escapeHtml(file.name)}</div>
                        <div class="file-meta">
                            ${formatFileSize(file.size)} ‚Ä¢ Created: ${new Date(file.created).toLocaleString()}
                        </div>
                    </div>
                    <div class="file-actions">
                        <button class="btn-download" onclick="downloadFile('${escapeHtml(file.name)}')" title="Download">
                            üíæ
                        </button>
                        <button class="btn-delete" onclick="deleteFile('${escapeHtml(file.name)}')" title="Delete">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            `).join("");
        }

        // Download file
        function downloadFile(filename) {
            const link = document.createElement('a');
            link.href = `/api/download/${encodeURIComponent(filename)}`;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Delete file
        async function deleteFile(filename) {
            if (!confirm(`Are you sure you want to delete "${filename}"?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/delete/${encodeURIComponent(filename)}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    // Refresh file list
                    loadAllFiles();
                } else {
                    alert(`Failed to delete file: ${result.error}`);
                }
            } catch (error) {
                alert(`Error deleting file: ${error.message}`);
            }
        }

        // Initialize
        loadAllFiles();

        // Refresh file list every 10 seconds
        setInterval(loadAllFiles, 10000);
    </script>
</body>

</html>